<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yangi Yil 2026 - Global Tabriklar</title>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        onValue,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
      // Firebase Storage removed (file uploads disabled)

      const firebaseConfig = {
        apiKey: "AIzaSyDWRzrAEGp8562_DXJAL7PQRwls2IBOGHA",
        authDomain: "yaniyil2026.firebaseapp.com",
        projectId: "yaniyil2026",
        storageBucket: "yaniyil2026.firebasestorage.app",
        messagingSenderId: "989025178210",
        appId: "1:989025178210:web:9dc0301f9d368ce2b2b73b",
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const tabriklarRef = ref(database, "tabriklar");
      const ADMIN_SECRET = "2026admin";
      const SITE_PASSWORD = "2026password";

      window.submitTabrik = function () {
        // Ensure user unlocked the site with site password first
        if (!window.siteUnlocked) {
          alert(
            "Iltimos avval kirish parolini kiriting va 'Kirish' tugmasini bosing."
          );
          return;
        }

        // Admin paroli
        const name = document.getElementById("nameInput").value.trim();
        const msg = document.getElementById("msgInput").value.trim();

        if (!name || !msg) {
          alert("Ism va tabrikni yozing");
          return;
        }

        const time = new Date().toLocaleString("uz-UZ", {
          day: "2-digit",
          month: "short",
          hour: "2-digit",
          minute: "2-digit",
        });

        // push message (attachments disabled)
        push(tabriklarRef, {
          name,
          msg,
          time,
          reactions: {
            "üëç": 0,
            "‚ù§Ô∏è": 0,
            "üéâ": 0,
          },
        });

        document.getElementById("nameInput").value = "";
        document.getElementById("msgInput").value = "";

        document.body.style.backgroundColor = "white";
        setTimeout(() => (document.body.style.backgroundColor = ""), 120);
      };

      // Check site password and reveal the form/messages
      window.checkSitePassword = function () {
        const entered = document.getElementById("sitepassword").value;
        if (!entered) {
          alert("Parolni kiriting");
          return;
        }
        if (entered !== SITE_PASSWORD) {
          alert("Parol noto‚Äòg‚Äòri");
          return;
        }

        // Reveal protected inputs and messages
        window.siteUnlocked = true;
        document
          .querySelectorAll(".protected")
          .forEach((el) => (el.style.display = "block"));
        document.getElementById("displayList").style.display = "block";
      };

      onValue(tabriklarRef, (snapshot) => {
        const data = snapshot.val();
        const list = document.getElementById("displayList");
        list.innerHTML = "";

        if (!data) return;

        Object.entries(data)
          .reverse()
          .forEach(([key, item]) => {
            const isAdmin =
              document.getElementById("adminCode")?.value === ADMIN_SECRET;

            // attachments feature removed

            list.innerHTML += `
          <div class="tabrik-box">
            <span class="timestamp">${item.time}</span>
            <strong style="color:#ffc300">üë§ ${item.name}</strong>
            <div>${item.msg}</div>
            <div class="react-display">
              <span>üëç ${item.reactions?.["üëç"] || 0}</span>
              <span style="margin-left:8px">‚ù§Ô∏è ${
                item.reactions?.["‚ù§Ô∏è"] || 0
              }</span>
              <span style="margin-left:8px">üéâ ${
                item.reactions?.["üéâ"] || 0
              }</span>
            </div>

<button onclick="showReply('${key}')">üí¨ Javob</button>

<div id="reply-${key}" style="display:none">
  <input id="rname-${key}" placeholder="Ism">
  <input id="rmsg-${key}" placeholder="Javob">
  <button onclick="sendReply('${key}')">Yuborish</button>
</div>
${
  item.replies
    ? Object.values(item.replies)
        .map(
          (r) => `
  <div style="margin-left:15px">
    ‚Ü™ <b>${r.name}</b>: ${r.msg}
  </div>
`
        )
        .join("")
    : ""
}

        ${
          isAdmin
            ? `<button onclick="deleteMsg('${key}')" style="margin-top:8px">üóë O‚Äòchirish</button>`
            : ""
        }
      </div>
    `;
          });
      });
      import { remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

      window.deleteMsg = function (key) {
        if (!confirm("O‚Äòchirilsinmi?")) return;
        remove(ref(database, "tabriklar/" + key));
      };
      // Reaksiya funksiyasi
      import { update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

      window.react = function (key, emoji) {
        const localKey = "reacted_" + key;
        // prevent multiple reactions from the same browser
        if (localStorage.getItem(localKey)) {
          alert("Siz bu xabarga allaqachon reaksiya bildirdingiz");
          return;
        }

        const emojiRef = ref(database, `tabriklar/${key}/reactions/${emoji}`);
        onValue(
          emojiRef,
          (snap) => {
            update(ref(database, `tabriklar/${key}/reactions`), {
              [emoji]: (snap.val() || 0) + 1,
            });
            // remember locally that this client reacted to this message
            try {
              localStorage.setItem(localKey, emoji);
            } catch (e) {
              console.warn("localStorage set failed", e);
            }
          },
          { onlyOnce: true }
        );
      };
      // Reply funksiyasi
      window.showReply = function (key) {
        document.getElementById(`reply-${key}`).style.display = "block";
      };

      window.sendReply = function (key) {
        const name = document.getElementById(`rname-${key}`).value;
        const msg = document.getElementById(`rmsg-${key}`).value;
        if (!name || !msg) return;

        const time = new Date().toLocaleTimeString("uz-UZ", {
          hour: "2-digit",
          minute: "2-digit",
        });

        push(ref(database, `tabriklar/${key}/replies`), { name, msg, time });
      };
    </script>

    <style>
      body {
        margin: 0;
        background: linear-gradient(to bottom, #001d3d, #000814);
        color: white;
        font-family: sans-serif;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 90%;
        max-width: 600px;
        text-align: center;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(15px);
      }
      input,
      textarea {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border-radius: 10px;
        border: none;
      }
      .main-btn {
        background: linear-gradient(45deg, #00b4d8, #0077b6);
        border: none;
        padding: 15px;
        border-radius: 30px;
        width: 100%;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }
      /* Reaction buttons should have transparent background */
      .tabrik-box button.react-btn {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 1rem;
        margin-right: 6px;
      }
      /* Sticker UI */
      /* Sticker UI removed */
      .tabrik-box {
        background: rgba(255, 255, 255, 0.08);
        padding: 15px;
        border-radius: 15px;
        margin-top: 15px;
        text-align: left;
        border-left: 5px solid #ffc300;
      }
      /* attachment UI removed */
      .timestamp {
        font-size: 0.7rem;
        opacity: 0.6;
        float: right;
      }
      .snowflake {
        position: fixed;
        top: -10px;
        animation: fall linear forwards;
      }
      @keyframes fall {
        to {
          transform: translateY(110vh);
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>‚ùÑÔ∏è 2026 Yangi Yil Tabriklari</h1>

      <div class="glass-card">
        <div style="display: flex; gap: 8px; align-items: center">
          <input
            type="password"
            id="sitepassword"
            placeholder="Kirish paroli"
          />
          <button
            class="main-btn"
            style="width: auto; padding: 10px 14px"
            onclick="checkSitePassword()"
          >
            Kirish
          </button>
        </div>

        <!-- showSitePass removed -->

        <!-- These are hidden until correct site password entered -->
        <input
          id="nameInput"
          class="protected"
          placeholder="Ismingiz"
          style="display: none"
        />
        <textarea
          id="msgInput"
          class="protected"
          rows="3"
          placeholder="Tabrik yozing..."
          style="display: none"
        ></textarea>
        <!-- file upload removed -->
        <input
          id="adminCode"
          class="protected"
          placeholder="Admin kod"
          type="password"
          style="display: none"
        />

        <button
          class="main-btn protected"
          style="display: none"
          onclick="submitTabrik()"
        >
          Yuborish
        </button>
      </div>

      <div id="displayList" style="padding-bottom: 50px; display: none"></div>
    </div>

    <script>
      // file upload handlers removed

      // debug upload helpers removed

      function snow() {
        const s = document.createElement("div");
        s.textContent = "‚ùÑ";
        s.className = "snowflake";
        s.style.left = Math.random() * 100 + "vw";
        s.style.fontSize = Math.random() * 20 + 10 + "px";
        const d = Math.random() * 3 + 3;
        s.style.animationDuration = d + "s";
        document.body.appendChild(s);
        setTimeout(() => s.remove(), d * 1000);
      }
      setInterval(snow, 150);
    </script>
  </body>
</html>
